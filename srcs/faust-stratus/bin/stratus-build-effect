##
## This script installs a Faust-designed Stratus effect algorithm library onto 
## the Stratus itself from a connected computer, using the installed effect SDK.
##
## You must have installed the Effects SDK on the Stratus before this will work.
##
## You run this script as foillows:
##
##     sdk-build-effect <location-of-your-dsp-file>
##
## All other arguments are passed to the faust2stratus script.
##
## If the build works, your shared library will be on the Stratus, and will also
## have been copied back to the same folder as your DSP file, along with the C++
## code generated by the Faust compiler.
##
DSP=${1:?First argument must be the Faust DSP file path}
shift

DSP=$(realpath $DSP)
DSP_FILENAME=$(basename $DSP)
DSP_NAME=${DSP_FILENAME%%.*}
DSP_FOLDER=$(dirname $DSP)

cd $(realpath $(dirname $0))

##
## Is the Stratus connected
##
TARGET_ADDRESS=stratus.local # the stratus network name
ping -c 1 -q $TARGET_ADDRESS >/dev/null 2>&1 || { echo "Cannot find Stratus connection. Please connect Stratus to your computer via USB"; false; }
##
## All this is done to ensure that we only ask for the SSH password once
##

TMP_DIR=$(mktemp -d)
SSH_CFG=$TMP_DIR/ssh-cfg
SSH_SOCKET=$TMP_DIR/ssh-socket
TARGET_USER=root
TARGET_PATH=/$TARGET_USER/$DSP_FILENAME
TARGET_PATH_PATTERN="/$TARGET_USER/$DSP_NAME*"

##
## Install cleanup routine
##
for sig in SIGTERM ERR EXIT; do trap "_term $sig" $sig; done
_term() {
  trap "" SIGTERM ERR EXIT
  # Close the SSH tunnel:
  ssh -F "$SSH_CFG" -S "$SSH_SOCKET" -O exit "$TARGET_ADDRESS" >/dev/null 2>&1
  rm -rf $TMP_DIR
  exit 0
}

# Create a temporary SSH config file:
cat > "$SSH_CFG" <<ENDCFG
Host *
        ControlMaster auto
        ControlPath $SSH_SOCKET
ENDCFG

# Open an SSH tunnel:
ssh -F "$SSH_CFG" -f -N -l $TARGET_USER $TARGET_ADDRESS

# Upload the DSP file:
scp -F "$SSH_CFG" "${DSP}" "$TARGET_USER@$TARGET_ADDRESS:/$TARGET_PATH"

# Build the effect:
ssh -F "$SSH_CFG" "$TARGET_USER@$TARGET_ADDRESS:/$TARGET_USER" -T <<ENDSSH
cd /$TARGET_USER
export CXXOPTIONS=${CXXOPTIONS:-}
faust2stratus "$DSP_FILENAME" "$@" || { echo "Build of $DSP_FILENAME failed"; exit 1; }
echo Build of $DSP_FILENAME succeeded
ENDSSH

# Download artifacts (whether or not the build failed)
scp -F "$SSH_CFG" "$TARGET_USER@$TARGET_ADDRESS:$TARGET_PATH_PATTERN" "$DSP_FOLDER"
